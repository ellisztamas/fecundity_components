---
title: "Supporting information"
author: "Thomas Ellis, Froukje Postma, Christopher Oakley and Jon Ågren"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  pdf_document:
    toc: true
  bookdown::pdf_book:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, fig.pos = 'H', eval=T)
library("qtl", quietly = T)
library(qtltools)
library(knitr)
library(vioplot)

```

```{r import-data, eval=T, include=FALSE}
source("R/parents.R")
# get the differences between parental means in each expeirment.
parent_diffs <- data.frame(
  it2010 = parents$delta[parents$site == "italy"  & parents$year == "2010"],
  it2011 = parents$delta[parents$site == "italy"  & parents$year == "2011"],
  sw2010 = parents$delta[parents$site == "sweden" & parents$year == "2010"],
  sw2011 = parents$delta[parents$site == "sweden" & parents$year == "2011"])
parent_diffs <- parent_diffs[c(1,3,2,6,4,7,5),]
parent_diffs$trait <- c("mass", "seed", "frut", "ffit", "surv", "tofu", "tfit")[c(1,3,2,6,4,7,5)]

# import QTL data
cross       <- readRDS(file='output/cross_objects.rds')
qtlmodels   <- readRDS(file='output/qtl_stepwise_models.rds')
qtlfits     <- readRDS(file='output/qtl_model_fits.rds')
qtlclusters <- readRDS(file='output/qtl_clusters.rds')

```

This document contains supporting tables and figures for the manuscript "Positive correlations among fecundity components boost estimates of local adaptation in *Arabidopsis thaliana*" by Thomas Ellis, Froukje Postma, Christopher Oakley and Jon Ågren.

```{r cluster-for-table, eval=F}
tabclusters  <- lapply(traits, function(x) return(NULL))
names(tabclusters) <- traits

# perform QTL clustering for each trait
library(qtltools)
for(i in traits){
  if(i == "surv"){
    dat <- cluster_qtl(1:5, qtlmodels[[i]][c(1,2,4)], qtlfits[[i]][c(1,2,4)], 15.2)$full.list
  } else {
    dat <- cluster_qtl(1:5, qtlmodels[[i]], qtlfits[[i]], 15.2)
  }
  tabclusters[[i]] <- dat
  
}

tabclusters$surv$experiment[tabclusters$surv$experiment == 3] <- 4
```

```{r table-of-clusters, eval=F}
# vector of columns to summarise
cmns <- c("ML_bayesint", "effect_sizes", "PVE","LOD")

dat <- tabclusters$mass$full.list

qtl <- unique(dat$QTL_id)

tab <- lapply(1:4, function(x) NULL)
for(e in 1:4){
  thisqtl <- as.data.frame(matrix(NA, nrow=length(qtl), ncol=length(cmns)))
  colnames(thisqtl) <- cmns
  
  for(i in 1:length(qtl)){
    q <- qtl[i]
    qx <- dat$experiment == e & dat$QTL_id ==q
    out <- round(dat[qx,cmns],2)
    if(nrow(out) == 0) out <- rep(NA, 4)
    cat(dim(out), e, q, "\n")
    thisqtl[i, ] <- out
  }
  tab[[e]] <- thisqtl
}
```

\newpage

```{r tab:individual-mass-qtl, eval=T}
site_names  <- c("Italy", "Italy", "Sweden", "Sweden")
year_names  <- c(2010, 2011, 2010, 2011)

# summary tables for each experiment
ix <- "mass"


tab <- list(bayesint_table(qtlmodels[[ix]]$it2010, qtlfits[[ix]]$it2010),
            bayesint_table(qtlmodels[[ix]]$it2011, qtlfits[[ix]]$it2011),
            bayesint_table(qtlmodels[[ix]]$sw2010, qtlfits[[ix]]$sw2010),
            bayesint_table(qtlmodels[[ix]]$sw2011, qtlfits[[ix]]$sw2011))

for(i in 1:4){
  tab[[i]]$site <- rep(site_names[i], nrow(tab[[i]])) # add experiment names
  tab[[i]]$year <- rep(year_names[i], nrow(tab[[i]])) # add experiment names
  tab[[i]]$PDE <- 100*abs(tab[[i]]$effect_sizes) / parent_diffs[parent_diffs$trait == ix, i]
}
tab <- do.call('rbind', tab)
# mash together positions with their CIs
tab$position <- paste(round(tab$ML_bayesint,1),
                      " (", round(tab$min_bayesint, 1), "-", round(tab$max_bayesint, 1), ")", sep="")
# print the table
kable(tab[,c("name", "site", "year","chr","position","LOD", "effect_sizes","PVE", "PDE")], digits = c(0,0,0,0,0,1,3,1,1),
      col.names = c("Name", "Site", "Year","Chr.","Position (cM)","LOD", "Effect size","% var. explained", "% diff. explained"),
      caption="QTL for seed mass identifed in individual experiments. QTL positions are shown with their 95% Bayesian credible intervals. Effect sizes are given as absolute values, as a percentage of variance among RIL means, and as a percentage of the difference between parental means.")
```

\newpage

```{r tab:individual-frut-qtl, eval=F}
# summary tables for fruits/plant
ix <- "frut"
tab <- list(bayesint_table(qtlmodels[[ix]]$it2010, qtlfits[[ix]]$it2010),
            bayesint_table(qtlmodels[[ix]]$it2011, qtlfits[[ix]]$it2011),
            bayesint_table(qtlmodels[[ix]]$sw2010, qtlfits[[ix]]$sw2010),
            bayesint_table(qtlmodels[[ix]]$sw2011, qtlfits[[ix]]$sw2011))

for(i in 1:4){
  tab[[i]]$site <- rep(site_names[i], nrow(tab[[i]])) # add experiment names
  tab[[i]]$year <- rep(year_names[i], nrow(tab[[i]])) # add experiment names
  tab[[i]]$PDE <- 100* abs(tab[[i]]$effect_sizes) / parent_diffs[parent_diffs$trait == ix, i]
}
tab <- do.call('rbind', tab)
# mash together positions with their CIs
tab$position <- paste(round(tab$ML_bayesint,1),
                      " (", round(tab$min_bayesint, 1), "-", round(tab$max_bayesint, 1), ")", sep="")
# print the table
kable(tab[,c("name", "site", "year","chr","position","LOD", "effect_sizes","PVE", "PDE")], digits = c(0,0,0,0,0,1,3,1,1),
      col.names = c("Name", "Site", "Year","Chr.","Position (cM)","LOD", "Effect size","% var. explained", "% diff. explained"),
      caption="QTL for fruit number per reproductive plant identifed in individual experiments. QTL positions are shown with their 95% Bayesian credible intervals. Effect sizes are given as absolute values, as a percentage of variance among RIL means, and as a percentage of the difference between parental means.")
```

\newpage

```{r tab:individual-seed-qtl, eval=T}
# seed number per fruit
ix <- "seed"
tab <- list(bayesint_table(qtlmodels[[ix]]$it2010, qtlfits[[ix]]$it2010),
            bayesint_table(qtlmodels[[ix]]$it2011, qtlfits[[ix]]$it2011),
            bayesint_table(qtlmodels[[ix]]$sw2010, qtlfits[[ix]]$sw2010),
            bayesint_table(qtlmodels[[ix]]$sw2011, qtlfits[[ix]]$sw2011))

for(i in 1:4){
  tab[[i]]$site <- rep(site_names[i], nrow(tab[[i]])) # add experiment names
  tab[[i]]$year <- rep(year_names[i], nrow(tab[[i]])) # add experiment names
  tab[[i]]$PDE <- 100 * abs(tab[[i]]$effect_sizes) / parent_diffs[parent_diffs$trait == ix, i]
}
tab <- do.call('rbind', tab)
# mash together positions with their CIs
tab$position <- paste(round(tab$ML_bayesint,1),
                      " (", round(tab$min_bayesint, 1), "-", round(tab$max_bayesint, 1), ")", sep="")
# print the table
kable(tab[,c("name", "site", "year","chr","position","LOD", "effect_sizes","PVE", "PDE")], digits = c(0,0,0,0,0,1,3,1,1,1),
      col.names = c("Name", "Site", "Year","Chr.","Position (cM)","LOD", "Effect size","% var. explained", "% diff. explained"),
      caption="QTL for seed number per fruit identifed in individual experiments. QTL positions are shown with their 95% Bayesian credible intervals. Effect sizes are given as absolute values, as a percentage of variance among RIL means, and as a percentage of the difference between parental means.")
```

\newpage

```{r tab:individual-tofu-qtl, eval=T}
# total fecundity
ix <- "tofu"
tab <- list(bayesint_table(qtlmodels[[ix]]$it2010, qtlfits[[ix]]$it2010),
            bayesint_table(qtlmodels[[ix]]$it2011, qtlfits[[ix]]$it2011),
            bayesint_table(qtlmodels[[ix]]$sw2010, qtlfits[[ix]]$sw2010),
            bayesint_table(qtlmodels[[ix]]$sw2011, qtlfits[[ix]]$sw2011))

for(i in 1:4){
  tab[[i]]$site <- rep(site_names[i], nrow(tab[[i]])) # add experiment names
  tab[[i]]$year <- rep(year_names[i], nrow(tab[[i]])) # add experiment names
  tab[[i]]$PDE <-100* abs(tab[[i]]$effect_sizes) / parent_diffs[parent_diffs$trait == ix, i]
}
tab <- do.call('rbind', tab)
# mash together positions with their CIs
tab$position <- paste(round(tab$ML_bayesint,1),
                      " (", round(tab$min_bayesint, 1), "-", round(tab$max_bayesint, 1), ")", sep="")
# print the table
kable(tab[,c("name", "site", "year","chr","position","LOD", "effect_sizes","PVE", "PDE")], digits = c(0,0,0,0,0,1,3,1,1),
      col.names = c("Name", "Site", "Year","Chr.","Position (cM)","LOD", "Effect size","% var. explained", "% diff. explained"),         caption = "QTL for seed number per reproductive plant identifed in individual experiments. QTL positions are shown with their 95% Bayesian credible intervals. Effect sizes are given as absolute values, as a percentage of variance among RIL means, and as a percentage of the difference between parental means.")

```

\newpage

```{r tab:individual-tfit-qtl, eval=T}
# seeds/seedling
ix <- "tfit"
tab <- list(bayesint_table(qtlmodels[[ix]]$it2010, qtlfits[[ix]]$it2010),
            bayesint_table(qtlmodels[[ix]]$it2011, qtlfits[[ix]]$it2011),
            bayesint_table(qtlmodels[[ix]]$sw2010, qtlfits[[ix]]$sw2010),
            bayesint_table(qtlmodels[[ix]]$sw2011, qtlfits[[ix]]$sw2011))

for(i in 1:4){
  tab[[i]]$site <- rep(site_names[i], nrow(tab[[i]])) # add experiment names
  tab[[i]]$year <- rep(year_names[i], nrow(tab[[i]])) # add experiment names
  tab[[i]]$PDE <- 100*abs(tab[[i]]$effect_sizes) / parent_diffs[parent_diffs$trait == ix, i]
}
tab <- do.call('rbind', tab)
# mash together positions with their CIs
tab$position <- paste(round(tab$ML_bayesint,1),
                      " (", round(tab$min_bayesint, 1), "-", round(tab$max_bayesint, 1), ")", sep="")
# print the table
kable(tab[,c("name", "site", "year","chr","position","LOD", "effect_sizes","PVE", "PDE")], digits = c(0,0,0,0,0,1,3,1,1),
      col.names = c("Name", "Site", "Year","Chr.","Position (cM)","LOD", "Effect size","% var. explained", "% diff. explained"),
      caption = "QTL for seed number per planted seedling identifed in individual experiments. QTL positions are shown with their 95% Bayesian credible intervals. Effect sizes are given as absolute values, as a percentage of variance among RIL means, and as a percentage of the difference between parental means.")

```

\newpage

```{r tab:individual-ffit-qtl, eval=F}
# Fruit number per seedling
ix <- "ffit"
tab <- list(bayesint_table(qtlmodels[[ix]]$it2010, qtlfits[[ix]]$it2010),
            bayesint_table(qtlmodels[[ix]]$it2011, qtlfits[[ix]]$it2011),
            bayesint_table(qtlmodels[[ix]]$sw2010, qtlfits[[ix]]$sw2010),
            bayesint_table(qtlmodels[[ix]]$sw2011, qtlfits[[ix]]$sw2011))

for(i in 1:4){
  tab[[i]]$site <- rep(site_names[i], nrow(tab[[i]])) # add experiment names
  tab[[i]]$year <- rep(year_names[i], nrow(tab[[i]])) # add experiment names
  tab[[i]]$PDE <- 100*abs(tab[[i]]$effect_sizes) / parent_diffs[parent_diffs$trait == ix, i]
}
tab <- do.call('rbind', tab)
# mash together positions with their CIs
tab$position <- paste(round(tab$ML_bayesint,1),
                      " (", round(tab$min_bayesint, 1), "-", round(tab$max_bayesint, 1), ")", sep="")
# print the table
kable(tab[,c("name", "site", "year","chr","position","LOD", "effect_sizes","PVE", "PDE")], digits = c(0,0,0,0,0,1,3,1,1),
      col.names = c("Name", "Site", "Year","Chr.","Position (cM)","LOD", "Effect size","% var. explained", "% diff. explained"),
      caption = "QTL for fruit number per planted seedling identifed in individual experiments. QTL positions are shown with their 95% Bayesian credible intervals. Effect sizes are given as absolute values, as a percentage of variance among RIL means, and as a percentage of the difference between parental means.")

```

\newpage

```{r tab:individual-surv-qtl, eval=F}
# survival to reproduction
site_names  <- c("Italy", "Italy", "Sweden")
year_names  <- c(2010, 2011, 2011)


ix <- "surv"
tab <- list(bayesint_table(qtlmodels[[ix]]$it2010, qtlfits[[ix]]$it2010),
            bayesint_table(qtlmodels[[ix]]$it2011, qtlfits[[ix]]$it2011),
            #bayesint_table(qtlmodels[[ix]]$sw2010, qtlfits[[ix]]$sw2010),
            bayesint_table(qtlmodels[[ix]]$sw2011, qtlfits[[ix]]$sw2011))

pd <- parent_diffs[parent_diffs$trait == ix,c(1,2,4)]

for(i in 1:3){
  tab[[i]]$site <- rep(site_names[i], nrow(tab[[i]])) # add experiment names
  tab[[i]]$year <- rep(year_names[i], nrow(tab[[i]])) # add experiment names
  tab[[i]]$PDE <- (100* abs(tab[[i]]$effect_sizes)) / as.numeric(pd[i])
}
tab <- do.call('rbind', tab)
# mash together positions with their CIs
tab$position <- paste(round(tab$ML_bayesint,1),
                      " (", round(tab$min_bayesint, 1), "-", round(tab$max_bayesint, 1), ")", sep="")
# print the table
kable(tab[,c("name", "site", "year","chr","position","LOD", "effect_sizes","PVE", "PDE")], digits = c(0,0,0,0,0,1,3,1),
      col.names = c("Name", "Site", "Year","Chr.","Position (cM)","LOD", "Effect size","% var. explained", "% diff. explained"),
      caption = "QTL for survival to reproduction identifed in individual experiments. QTL positions are shown with their 95% Bayesian credible intervals. Effect sizes are given as absolute values, as a percentage of variance among RIL means, and as a percentage of the difference between parental means.")

```

\newpage

```{r tab: epistatic-qtl, eval=T}

# function to extract information about epistatic interactions.
epi_fun <- function(x) {
  d <- summary(x)
  i <- nrow(d$result.drop)
  c(row.names(d$ests)[i+1], d$ests[i, 1], d$result.drop[i, c(3,4)])
}

trait_names <- c("Seed mass", "Fruits/RP", "Seeds/fr", "Seeds/RP", "Fruits/sdl", "Seeds/sdl", "Survival")
site_names  <- c("Italy", "Italy", "Sweden", "Sweden")
year_names  <- c(2010, 2011, 2010, 2011)

epi_tab <- matrix(NA, ncol=8, nrow=0)

# for(tr in c(1,3,4,6)){
for(tr in 1:7){
  for(sy in 1:4){
    if(length(qtlmodels[[tr]][[sy]]) > 0){
      if(length(strsplit(formula(qtlmodels[[tr]][[sy]]), ":")[[1]]) > 1){
        tab <- epi_fun(qtlfits[[tr]][[sy]])
        
        tab <- c(tab, abs(round(100*as.numeric(tab[2]) / parent_diffs[parent_diffs$trait== names(qtlfits)[tr], sy], 1)))
        # print(as.numeric(tab[2]) / parent_diffs[parent_diffs$trait== names(qtlfits)[tr], sy])
        epi_tab <- rbind(epi_tab, c(trait_names[tr], site_names[sy], year_names[sy], tab))
      }
    }
  }
}

epi_tab <- as.data.frame(epi_tab)
colnames(epi_tab) <- c("Trait",   "Site", "Year", "QTL", "Effect size", "LOD", "% var. explained", "% diff. explained")
for(c in 5:7) epi_tab[,c] <- round(as.numeric(as.vector(epi_tab[,c])), 2)

kable(epi_tab, digits = c(0,0,0,0,1,1,1, 1),
      caption = "Pairs of significant epistatic QTL  for fruit number per reproductive plant (Fruits/RP), seed number per fruit (Seeds/fr), seed number per reproductive plant (Seeds/RP), seed mass (Sd mass) and survival to reproduction (Surv). Effect sizes are given as absolute values, as a percentage of variance among RIL means, and as a percentage of the difference between parental means.")
```

\newpage

```{r path-diagram, echo=FALSE, fig.cap="Putative path diagram indicating traits used in this study. In addition, fruit number per planted seedling is used, but not shown. Red indicates components of fecundity, blue components of fitness. Dashed lines indicate possible trade-off relationships investigated in this study. Asterisks indicate traits which are estimated as a product of components and not directly observed; see text for details."}
include_graphics('../figures/trait_path_diagram.pdf')
```

\newpage

```{r fig: epistatic-mass, fig.width=8/2.54, cache=T, cache.lazy=T, fig.cap="Interaction plots for the epistatic interaction detected for seed mass, showing mean and standard errors for each genotype-by-genotype combination."}
# seed mass
par(mfrow=c(1,1))
effectplot(cross$mass, pheno.col = "sw2010", mname1 = "2@22.0", mname2 = "5@2.6", add.legend = F,
           main = "Sweden 2010", xlab="QTL 5:2.6", ylab="Seed mass (mg)")
legend('topleft', legend = c("QTL 2:22.0","ItIt", "SwSw"), col=c(0,2,4), pch=1, bty="n")
```

```{r fig: epistatic-seed, fig.width=16.9/2.54, fig.height=10/2.54, cache=T, cache.lazy=T, fig.cap="Interaction plots for epistatic interactions detected for seed number per fruit, showing mean and standard errors for each genotype-by-genotype combination."}
# seed number per fruit
par(mfrow=c(1,3))
effectplot(cross$seed, pheno.col = "it2011", mname1 = "1@5.3", mname2 = "5@15.0", add.legend = F,
           main = "Italy 2011", xlab="QTL 5:15.0", ylab="Seed number per fruit")
legend('topright', c("QTL 1:5.3","ItIt", "SwSw"), col=c(0,2,4), pch=1, bty="n")

effectplot(cross$seed, pheno.col = "sw2010", mname1 = "1@22.7", mname2 = "5@70.1", add.legend = F,
           main = "Sweden 2010", xlab="QTL 5:70.1", ylab="Seed number per fruit")
legend('topright', c("QTL 1:22.7","ItIt", "SwSw"), col=c(0,2,4), pch=1, bty="n")

effectplot(cross$seed, pheno.col = "sw2011", mname1 = "1@61.1", mname2 = "3@22.0", add.legend = F,
           main = "Sweden 2011", xlab="QTL 3:22.0", ylab="Seed number per fruit")
legend('topright', c("QTL 1@61.1","ItIt", "SwSw"), col=c(0,2,4), pch=1, bty="n")
```

```{r fig: epistatic-frut, eval=F, fig.width=8/2.54, fig.height=10/2.54, cache=T, cache.lazy=T, fig.cap="Interaction plots for epistatic interactions detected for fruit number per reproductive plant, showing mean and standard errors for each genotype-by-genotype combination."}
#fruit number per plant
par(mfrow=c(1,1))
# effectplot(cross$frut, pheno.col = "it2010", mname1 = "5@7.7", mname2 = "5@70.1", add.legend = F,
#            main = "Italy 2010", xlab="QTL 5:70.1", ylab="fruit number per reproductive plant")
# legend(1.4,16, c("QTL 5:7.7","ItIt", "SwSw"), col=c(0,2,4), pch=1, bty="n")

effectplot(cross$frut, pheno.col = "sw2011", mname1 = "1@61.8", mname2 = "3@26.7", add.legend = F, ylim=c(16,30),
           main = "Sweden 2011", xlab="QTL 3:26.7", ylab="Fruit number per reproductive plant")
legend('bottomleft', c("QTL 1:61.8","ItIt", "SwSw"), col=c(0,2,4), pch=1, bty="n")
```

```{r fig: epistatic-ffit, eval=F, fig.width=16.9/2.54, fig.height=10/2.54, cache=T, cache.lazy=T, fig.cap="Interaction plots for epistatic interactions detected for fruit number per planted seedling, showing mean and standard errors for each genotype-by-genotype combination."}
#fruit number per plant
par(mfrow=c(1,2))
effectplot(cross$ffit, pheno.col = "it2010", mname1 = "4@50.0", mname2 = "5@54.8", add.legend = F,
           main = "Italy 2010", xlab="QTL 5:54.8", ylab="fruit number per reproductive plant")
legend('bottomleft', c("QTL 4:50.0", "ItIt", "SwSw"), col=c(0,2,4), pch=1, bty="n")

effectplot(cross$frut, pheno.col = "sw2011", mname1 = "1@61.8", mname2 = "3@26.7", add.legend = F, ylim=c(16,30),
           main = "Sweden 2011", xlab="QTL 3:26.7", ylab="Fruit number per reproductive plant")
legend('bottomleft', c("QTL 1:61.8","ItIt", "SwSw"), col=c(0,2,4), pch=1, bty="n")
```


```{r fig: epistatic-tofu, eval=T, fig.width=8/2.54, fig.height=10/2.54, cache=T, cache.lazy=T, fig.cap="Interaction plots for epistatic interactions detected for seed number per reproductive plant, showing mean and standard errors for each genotype-by-genotype combination."}
# seed number per plant
par(mfrow=c(1,1))
effectplot(cross$tofu, pheno.col = "sw2011", mname1 = "1@61.1", mname2 = "3@24.4", add.legend = F, ylim=c(500,1100),
           main = "Sweden 2011", xlab="QTL 3:24.4", ylab="Seed number per reproductive plant")
legend('bottomleft', c("QTL 1.61.1","ItIt", "SwSw"), col=c(0,2,4), pch=1, bty="n")

```

```{r fig: epistatic-tfit, fig.width=16.9/2.54, fig.height=10/2.54, cache=T, cache.lazy=T, fig.cap="Interaction plots for epistatic interactions detected for seed number per planted seedling, showing mean and standard errors for each genotype-by-genotype combination."}
# seed number per plant
par(mfrow=c(1,2))
effectplot(cross$tofu, pheno.col = "it2010", mname1 = "5@43.0", mname2 = "5@74.5", add.legend = F,
           main = "Italy 2010", xlab="QTL 5:74.5", ylab="seed number per reproductive plant")
legend('bottomleft', c("QTL 3:6.3","ItIt", "SwSw"), col=c(0,2,4), pch=1, bty="n")

effectplot(cross$tofu, pheno.col = "sw2011", mname1 = "1@61.1", mname2 = "3@24.4", add.legend = F, ylim=c(500,1100),
           main = "Sweden 2011", xlab="QTL 3:24.4", ylab="Seed number per reproductive plant")
legend('bottomleft', c("QTL 1.61.1","ItIt", "SwSw"), col=c(0,2,4), pch=1, bty="n")

```
