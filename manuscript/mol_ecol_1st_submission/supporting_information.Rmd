---
title: "Supporting information"
author: "Thomas James Ellis, Froukje M. Postma, Christopher G. Oakley and Jon Ågren"
date: "`r format(Sys.time(), '%d %B %Y')`"
graphics: yes
output:
  pdf_document:
    toc: false
    fig_caption: yes
  bookdown::pdf_book:
    toc: no
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, eval=T)
library("qtl", quietly = T)
library("arghqtl")
library("knitr")
#library('kableExtra')
library("magrittr")
```

```{r import-data, eval=T, include=FALSE}
source("R/001.parents.R")
# get the differences between parental means in each expeirment.
parent_diffs <- data.frame(
  it2010 = parents$delta[parents$site == "italy"  & parents$year == "2010"],
  it2011 = parents$delta[parents$site == "italy"  & parents$year == "2011"],
  sw2010 = parents$delta[parents$site == "sweden" & parents$year == "2010"],
  sw2011 = parents$delta[parents$site == "sweden" & parents$year == "2011"])
parent_diffs <- parent_diffs[c(1,3,2,6,4,7,5),]
parent_diffs$trait <- c("mass", "seed", "frut", "ffit", "surv", "tofu", "tfit")[c(1,3,2,6,4,7,5)]
# RIL phenotypes
ril_numb <- read.csv('data_derived/RIL_seeds_per_fruit.csv')
ril_mass <- read.csv('data_derived/RIL_seed_mass.csv')
ril_frut <- read.csv("data_derived/RIL_fruits_per_adult.csv")
ril_tofu <- read.csv('data_derived/RIL_seeds_per_adult.csv')
ril_surv <- read.csv('data_derived/RIL_survival.csv')
# import QTL data
cross       <- readRDS(file='output/cross_objects.rds')
qtl_stepwise   <- readRDS(file='output/qtl_stepwise_models.rds')
qtl_fits     <- readRDS(file='output/qtl_model_fits.rds')
# Heritability estimates and confidence intervals
H2 <- readRDS("output/heritabilities.rds")
# Genetic correlations
rhos <- read.csv('output/genetic_correlations.csv')
# Traits to be presented.
traits <- c("mass","seed", "tofu", "tfit")

site_names  <- c("Italy", "Italy", "Sweden", "Sweden")
year_names  <- c(2010, 2011, 2010, 2011)
```

This document contains supporting tables and figures for the manuscript "Life-history tradeoffs, and the genetic basis of fitness in *Arabidopsis thaliana*" by Thomas James Ellis, Froukje M. Postma, Christopher G. Oakley and Jon Ågren.

**Tables:**

  1. Individual QTL for number of seeds per fruit
  2. Individual QTL for number of seeds per reproductive plant
  3. Individual QTL for number of fruits per reproductive plant
  4. Individual QTL for number of fruits per seedling planted
  5. Individual QTL for number of seeds per seedling planted
  6. Individual QTL for seed mass
  7. Individual QTL for survival
  8. Epistatic interactions

**Figures:**

  1. Seed mass differences between parental lines
  2. Scatter plots of RIL-means for fecundity and survival, components of fecundity, and fecundity and seed mass
  3. Epistatic interactions for number of seeds per fruit
  4. Epistatic interactions for number of seeds per reproductive plant
  5. Epistatic interactions for number of seeds per seedling planted
  6. Broad-sense heritability estimates

\newpage

```{r qtl-summary-table, eval=FALSE}
# Create a table summarising results of QTL models.
# This creates a table for all seven traits, but then prints only the ones that
# are new in this study.

# name, number, LOD, PVE, %parents
qtl_tab <- data.frame(
  trait = c("Seed mass", "Fruits/RP", "Seeds/fr", "Seeds/RP", "Fruits/sdl", "Seeds/sdl", "Survival"),
  # Italy 2010
  n.QTL = sapply(qtl_stepwise, function(x) x$it2010$n.qtl),
  LOD   = sapply(qtl_fits, function(x) x$it2010$result.full[1,4]),
  PVE   = sapply(qtl_fits, function(x) x$it2010$result.full[1,5]),
  #ofparents = 100 * sapply(qtl_fits, function(x) abs(sum(x$it2010$ests$ests[-1]))) / parent_diffs[,1],
  # Italy 2011
  n.QTL = sapply(qtl_stepwise, function(x) x$it2011$n.qtl),
  LOD   = sapply(qtl_fits, function(x) x$it2011$result.full[1,4]),
  PVE   = sapply(qtl_fits, function(x) x$it2011$result.full[1,5]),
  # ofparents = 100 * sapply(qtl_fits, function(x) abs(sum(x$it2011$ests$ests[-1]))) / parent_diffs[,2],
  # Sweden 2010
  n.QTL = c(sapply(qtl_stepwise[1:6], function(x) x$sw2010$n.qtl),0),
  LOD   = c(sapply(qtl_fits[1:6], function(x) x$sw2010$result.full[1,4]),0),
  PVE   = c(sapply(qtl_fits[1:6], function(x) x$sw2010$result.full[1,5]),0),
  # ofparents = c(100 * sapply(qtl_fits[1:6], function(x) abs(sum(x$sw2010$ests$ests[-1]))) / parent_diffs[1:6,3],0),
  # Sweden 2011
  n.QTL = sapply(qtl_stepwise, function(x) x$sw2011$n.qtl),
  LOD   = sapply(qtl_fits, function(x) x$sw2011$result.full[1,4]),
  PVE   = sapply(qtl_fits, function(x) x$sw2011$result.full[1,5])
  # ofparents = 100 * sapply(qtl_fits, function(x) abs(sum(x$sw2011$ests$ests[-1]))) / parent_diffs[,4]
)

qtl_tab <- qtl_tab[c("frut","seed", "tofu", "surv", "mass", "ffit", "tfit"),]

kable(qtl_tab, row.names = F, digits = 1,
      format= "latex",
      col.names = c("Trait",
                    "no. QTL", "LOD", "PVE",
                    "no. QTL", "LOD", "PVE",
                    "no. QTL", "LOD", "PVE",
                    "no. QTL", "LOD", "PVE"),
      caption = "Summary of QTL models for number of fruits per reproductive plant (Fruits/RP), number of seeds per fruit (Seeds/fr), number of seeds per reproductive plant (Seeds/RP), survival to reproduction, seed mass, number of fruits per seedling planted (Fruits/sdl) and number of seeds per seedling planted (Seeds/sdl). Number of QTL detected, LOD scores, and percentage of variance in RIL means explained (PVE) are given for each site-by-year combination.") %>%
  add_header_above(c(" " = 1, "Italy 2010" = 3, "Italy 2011" = 3, "Sweden 2010" = 3, "Sweden 2011"=3)) %>%
  landscape()

```

```{r tab:individual-seed-qtl, fig.scap: "QTL for number of seeds per fruit", fig.align='center', eval=T}
# number of seeds per fruit
ix <- "seed"
tab <- list(bayesint_table(qtl_stepwise[[ix]]$it2010, qtl_fits[[ix]]$it2010),
            bayesint_table(qtl_stepwise[[ix]]$it2011, qtl_fits[[ix]]$it2011),
            bayesint_table(qtl_stepwise[[ix]]$sw2010, qtl_fits[[ix]]$sw2010),
            bayesint_table(qtl_stepwise[[ix]]$sw2011, qtl_fits[[ix]]$sw2011))

for(i in 1:4){
  tab[[i]]$site <- rep(site_names[i], nrow(tab[[i]])) # add experiment names
  tab[[i]]$year <- rep(year_names[i], nrow(tab[[i]])) # add experiment names
  #tab[[i]]$PDE <- 100*abs(tab[[i]]$effect_sizes) / parent_diffs[parent_diffs$trait == ix, i]
}
tab <- do.call('rbind', tab)
# mash together positions with their CIs
tab$position <- paste(format(round(tab$ML_bayesint,1), nsmall = 1),
                      " (",
                      format(round(tab$min_bayesint, 1), nsmall = 1), 
                      "-",
                      format(round(tab$max_bayesint, 1), nsmall = 1),
                      ")",
                      sep="")
# print the table
kable(tab[,c("name", "site", "year","chr","position","LOD", "effect_sizes","PVE")],#, "PDE")],
      format="pandoc",
      digits = c(0,0,0,0,0,1,3,1,1),
      col.names = c("Name", "Site", "Year","Chr.","Position (cM)","LOD", "Effect size","% var. explained"),# "% diff. explained"),
      caption="QTL for number of seeds per fruit identifed in individual experiments. QTL positions are shown with their 95% Bayesian credible intervals. Effect sizes are given as absolute values and as a percentage of variance among RIL means.")
```

\newpage

```{r tab:individual-tofu-qtl, eval=T}
# total fecundity
ix <- "tofu"
tab <- list(bayesint_table(qtl_stepwise[[ix]]$it2010, qtl_fits[[ix]]$it2010),
            bayesint_table(qtl_stepwise[[ix]]$it2011, qtl_fits[[ix]]$it2011),
            bayesint_table(qtl_stepwise[[ix]]$sw2010, qtl_fits[[ix]]$sw2010),
            bayesint_table(qtl_stepwise[[ix]]$sw2011, qtl_fits[[ix]]$sw2011))

for(i in 1:4){
  tab[[i]]$site <- rep(site_names[i], nrow(tab[[i]])) # add experiment names
  tab[[i]]$year <- rep(year_names[i], nrow(tab[[i]])) # add experiment names
  #tab[[i]]$PDE <- 100*abs(tab[[i]]$effect_sizes) / parent_diffs[parent_diffs$trait == ix, i]
}
tab <- do.call('rbind', tab)
# mash together positions with their CIs
tab$position <- paste(format(round(tab$ML_bayesint,1), nsmall = 1),
                      " (",
                      format(round(tab$min_bayesint, 1), nsmall = 1), 
                      "-",
                      format(round(tab$max_bayesint, 1), nsmall = 1),
                      ")",
                      sep="")
# print the table
kable(tab[,c("name", "site", "year","chr","position","LOD", "effect_sizes","PVE")],#, "PDE")],
      format="pandoc",
      digits = c(0,0,0,0,0,1,3,1,1),
      col.names = c("Name", "Site", "Year","Chr.","Position (cM)","LOD", "Effect size","% var. explained"),# "% diff. explained"),
      caption = "QTL for number of seeds per reproductive plant identifed in individual experiments. QTL positions are shown with their 95% Bayesian credible intervals. Effect sizes are given as absolute values and as a percentage of variance among RIL means.")

```

\newpage

```{r tab:individual-frut-qtl, eval=T}
# summary tables for fruits/plant
ix <- "frut"
tab <- list(bayesint_table(qtl_stepwise[[ix]]$it2010, qtl_fits[[ix]]$it2010),
            bayesint_table(qtl_stepwise[[ix]]$it2011, qtl_fits[[ix]]$it2011),
            bayesint_table(qtl_stepwise[[ix]]$sw2010, qtl_fits[[ix]]$sw2010),
            bayesint_table(qtl_stepwise[[ix]]$sw2011, qtl_fits[[ix]]$sw2011))

for(i in 1:4){
  tab[[i]]$site <- rep(site_names[i], nrow(tab[[i]])) # add experiment names
  tab[[i]]$year <- rep(year_names[i], nrow(tab[[i]])) # add experiment names
  #tab[[i]]$PDE <- 100*abs(tab[[i]]$effect_sizes) / parent_diffs[parent_diffs$trait == ix, i]
}
tab <- do.call('rbind', tab)
# mash together positions with their CIs
tab$position <- paste(format(round(tab$ML_bayesint,1), nsmall = 1),
                      " (",
                      format(round(tab$min_bayesint, 1), nsmall = 1), 
                      "-",
                      format(round(tab$max_bayesint, 1), nsmall = 1),
                      ")",
                      sep="")
# print the table
kable(tab[,c("name", "site", "year","chr","position","LOD", "effect_sizes","PVE")],#, "PDE")],
      format="pandoc",
      digits = c(0,0,0,0,0,1,3,1,1),
      col.names = c("Name", "Site", "Year","Chr.","Position (cM)","LOD", "Effect size","% var. explained"),# "% diff. explained"),
      caption="QTL for number of fruits per reproductive plant identifed in individual experiments. QTL positions are shown with their 95% Bayesian credible intervals. Effect sizes are given as absolute values and as a percentage of variance among RIL means.")
```

\newpage

```{r tab:individual-ffit-qtl, eval=T}
# number of fruits per seedling
ix <- "ffit"
tab <- list(bayesint_table(qtl_stepwise[[ix]]$it2010, qtl_fits[[ix]]$it2010),
            bayesint_table(qtl_stepwise[[ix]]$it2011, qtl_fits[[ix]]$it2011),
            bayesint_table(qtl_stepwise[[ix]]$sw2010, qtl_fits[[ix]]$sw2010),
            bayesint_table(qtl_stepwise[[ix]]$sw2011, qtl_fits[[ix]]$sw2011))

for(i in 1:4){
  tab[[i]]$site <- rep(site_names[i], nrow(tab[[i]])) # add experiment names
  tab[[i]]$year <- rep(year_names[i], nrow(tab[[i]])) # add experiment names
  tab[[i]]$PDE <- 100*abs(tab[[i]]$effect_sizes) / parent_diffs[parent_diffs$trait == ix, i]
}
tab <- do.call('rbind', tab)
# mash together positions with their CIs
tab$position <- paste(format(round(tab$ML_bayesint,1), nsmall = 1),
                      " (",
                      format(round(tab$min_bayesint, 1), nsmall = 1), 
                      "-",
                      format(round(tab$max_bayesint, 1), nsmall = 1),
                      ")",
                      sep="")
# print the table
kable(tab[,c("name", "site", "year","chr","position","LOD", "effect_sizes","PVE")],# "PDE")],
      format= "pandoc",
      digits = c(0,0,0,0,0,1,3,1,1),
      col.names = c("Name", "Site", "Year","Chr.","Position (cM)","LOD", "Effect size","% var. explained"),# "% diff. explained"),
      caption = "QTL for number of fruits per seedling planted identifed in individual experiments. QTL positions are shown with their 95% Bayesian credible intervals. Effect sizes are given as absolute values, as a percentage of variance among RIL means, and as a percentage of the difference between parental means.")

```

\newpage

```{r tab:individual-tfit-qtl, eval=T}
# seeds/seedling
ix <- "tfit"
tab <- list(bayesint_table(qtl_stepwise[[ix]]$it2010, qtl_fits[[ix]]$it2010),
            bayesint_table(qtl_stepwise[[ix]]$it2011, qtl_fits[[ix]]$it2011),
            bayesint_table(qtl_stepwise[[ix]]$sw2010, qtl_fits[[ix]]$sw2010),
            bayesint_table(qtl_stepwise[[ix]]$sw2011, qtl_fits[[ix]]$sw2011))

for(i in 1:4){
  tab[[i]]$site <- rep(site_names[i], nrow(tab[[i]])) # add experiment names
  tab[[i]]$year <- rep(year_names[i], nrow(tab[[i]])) # add experiment names
  #tab[[i]]$PDE <- 100*abs(tab[[i]]$effect_sizes) / parent_diffs[parent_diffs$trait == ix, i]
}
tab <- do.call('rbind', tab)
# mash together positions with their CIs
tab$position <- paste(format(round(tab$ML_bayesint,1), nsmall = 1),
                      " (",
                      format(round(tab$min_bayesint, 1), nsmall = 1), 
                      "-",
                      format(round(tab$max_bayesint, 1), nsmall = 1),
                      ")",
                      sep="")
# print the table
kable(tab[,c("name", "site", "year","chr","position","LOD", "effect_sizes","PVE")],#, "PDE")],
      format= "pandoc",
      digits = c(0,0,0,0,0,1,3,1,1),
      col.names = c("Name", "Site", "Year","Chr.","Position (cM)","LOD", "Effect size","% var. explained"),# "% diff. explained"),
      caption = "QTL for number of seeds per seedling planted identifed in individual experiments. QTL positions are shown with their 95% Bayesian credible intervals. Effect sizes are given as absolute values and as a percentage of variance among RIL means.")

```

\newpage

```{r tab:individual-mass-qtl, eval=T}
# summary tables for each experiment
ix <- "mass"

tab <- list(bayesint_table(qtl_stepwise[[ix]]$it2010, qtl_fits[[ix]]$it2010),
            bayesint_table(qtl_stepwise[[ix]]$it2011, qtl_fits[[ix]]$it2011),
            bayesint_table(qtl_stepwise[[ix]]$sw2010, qtl_fits[[ix]]$sw2010),
            bayesint_table(qtl_stepwise[[ix]]$sw2011, qtl_fits[[ix]]$sw2011))

for(i in 1:4){
  tab[[i]]$site <- rep(site_names[i], nrow(tab[[i]])) # add experiment names
  tab[[i]]$year <- rep(year_names[i], nrow(tab[[i]])) # add experiment names
  #tab[[i]]$PDE <- 100*abs(tab[[i]]$effect_sizes) / parent_diffs[parent_diffs$trait == ix, i]
}
tab <- do.call('rbind', tab)
 
tab$site <- as.factor(tab$site)

# mash together positions with their CIs
tab$position <- paste(format(round(tab$ML_bayesint,1), nsmall = 1),
                      " (",
                      format(round(tab$min_bayesint, 1), nsmall = 1), 
                      "-",
                      format(round(tab$max_bayesint, 1), nsmall = 1),
                      ")",
                      sep="")
d <- tab[,c("name", "site", "year","chr","position","LOD", "effect_sizes","PVE")]
# print the table
kable(d,#tab[,c("name", "site", "year","chr","position","LOD", "effect_sizes","PVE")],#, "PDE")],
      format= "pandoc",
      digits = c(0,0,0,0,0,1,3,1,1),
      col.names = c("Name", "Site", "Year","Chr.","Position (cM)","LOD", "Effect size","% var. explained"),# "% diff. explained"),
      caption="QTL for seed mass identifed in individual experiments. QTL positions are shown with their 95% Bayesian credible intervals. Effect sizes are given as absolute values and as a percentage of variance among RIL means.")
```

\newpage

```{r tab:individual-surv-qtl, eval=T}
# survival to reproduction
site_names  <- c("Italy", "Italy", "Sweden")
year_names  <- c(2010, 2011, 2011)


ix <- "surv"
tab <- list(bayesint_table(qtl_stepwise[[ix]]$it2010, qtl_fits[[ix]]$it2010),
            bayesint_table(qtl_stepwise[[ix]]$it2011, qtl_fits[[ix]]$it2011),
            #bayesint_table(qtl_stepwise[[ix]]$sw2010, qtl_fits[[ix]]$sw2010),
            bayesint_table(qtl_stepwise[[ix]]$sw2011, qtl_fits[[ix]]$sw2011))

pd <- parent_diffs[parent_diffs$trait == ix,c(1,2,4)]

for(i in 1:3){
  tab[[i]]$site <- rep(site_names[i], nrow(tab[[i]])) # add experiment names
  tab[[i]]$year <- rep(year_names[i], nrow(tab[[i]])) # add experiment names
  tab[[i]]$PDE <- (100* abs(tab[[i]]$effect_sizes)) / as.numeric(pd[i])
}
tab <- do.call('rbind', tab)
# mash together positions with their CIs
tab$position <- paste(format(round(tab$ML_bayesint,1), nsmall = 1),
                      " (",
                      format(round(tab$min_bayesint, 1), nsmall = 1), 
                      "-",
                      format(round(tab$max_bayesint, 1), nsmall = 1),
                      ")",
                      sep="")
# print the table
kable(tab[,c("name", "site", "year","chr","position","LOD", "effect_sizes","PVE")],# "PDE")],
      format= "pandoc",
      digits = c(0,0,0,0,0,1,3,1),
      col.names = c("Name", "Site", "Year","Chr.","Position (cM)","LOD", "Effect size","% var. explained"),# "% diff. explained"),
      caption = "QTL for survival to reproduction identifed in individual experiments. QTL positions are shown with their 95% Bayesian credible intervals. Effect sizes are given as absolute values, as a percentage of variance among RIL means, and as a percentage of the difference between parental means.")

```

\newpage

```{r epistatic-qtl-table, eval=T}
epi_tab <- matrix(NA, nrow = 0, ncol=11)

for(tr in traits){
  for(sy in c("it2010", "it2011", "sw2010","sw2011")){
    eepi_tab <- grep(":", row.names(summary(qtl_fits[[tr]][[sy]])$result.drop))
    this_summ <- summary(qtl_fits[[tr]][[sy]])$result.drop[eepi_tab,]
    this_summ <- c(tr, substr(sy, 1,2), substr(sy, 3,6),
                   row.names(summary(qtl_fits[[tr]][[sy]])$result.drop)[eepi_tab], this_summ)
    if(!all(this_summ %in% c(tr, substr(sy, 1,2), substr(sy, 3,6)))) epi_tab <- rbind(epi_tab, this_summ)
  }
}

epi_tab <- as.data.frame(epi_tab)
colnames(epi_tab)[1:4] <- c("Trait", "Site","Year", "QTL")
epi_tab <- epi_tab[, c("Trait", "Site","Year", "QTL", "LOD", "%var")]
# Comvert values from factors
epi_tab$Trait  <- as.vector(epi_tab$Trait)
epi_tab$LOD    <- as.numeric(as.vector(epi_tab$LOD))
epi_tab$`%var` <- as.numeric(as.vector(epi_tab$`%var`))

# Add prettier names
epi_tab$Trait[epi_tab$Trait == "seed"] <- "Seeds per fruit"
epi_tab$Trait[epi_tab$Trait == "tofu"] <- "Seeds per reproductive plant"
epi_tab$Trait[epi_tab$Trait == "tfit"] <- "Seeds per seedling planted"

epi_tab$Site <- ifelse(epi_tab$Site == "it", "Italy", "Sweden")

kable(epi_tab, digits = 2, row.names = F,
      format= "pandoc",
      col.names = c("Trait", "Site","Year", "QTL", "LOD", "% var. explained"),
      caption = "Pairs of significant epistatic QTL detected across traits.")
```

\newpage

```{r seed-mass, fig.cap="Mean seed mass of the Italian (closed symbols) and Swedish (open symbols) parental ecotypes at the field sites in Italy (It.) and Sweden (Sw.) in 2010 and 2011. Bars indicate standard error.", fig.scap = "Seed mass among parental lines", fig.align= "center", fig.width=8/2.54}
# pdf("figures/02_seed_mass.pdf", width=11/2.54)

par(mfrow=c(1,1))
plot(c(1,4), c(15,30), type='n', axes = F, xlim=c(0.5, 4.5), xlab="",
     ylab=expression(paste("Seed mass (",mu, "g)")))
axis(2); box(); grid()
axis(1, 1:4, c("It. 2010", "It. 2011", "Sw. 2010", "Sw. 2011"), las=2, tick = T)

os <- 0.05
segments((1:4)-os, (parents$it_parent+parents$it_se)[parents$variable == 'seed_mass'],
         (1:4)-os, (parents$it_parent-parents$it_se)[parents$variable == 'seed_mass'],
         lwd=2)
segments((1:4)+os, (parents$sw_parent+parents$sw_se)[parents$variable == 'seed_mass'],
         (1:4)+os, (parents$sw_parent-parents$sw_se)[parents$variable == 'seed_mass'],
         lwd=2)
points((1:4)-os, parents$it_parent[parents$variable == 'seed_mass'], pch=16)
points((1:4)+os, parents$sw_parent[parents$variable == 'seed_mass'], pch=21, bg='white')


# dev.off()
```

\newpage

```{r scatter-plots, fig.height=16/2.54, fig.width=16.9/2.54, fig.cap="Relationships between RIL-means for survival and fecundity (top), components of fecundity (middle), and between overall fecundity and seed mass (bottom). Pearson correlation coefficients ($r_P$) and associated $p$-values are indicated.", fig.scap = "Scatter plots between RIL-means for survival and fecundity, components of fecundity, and between overall fecundity and seed mass", fig.align= "center"}


corsumm <- data.frame(rho = round(rhos$obs, 2),
                      p   = round(rhos$p, 3))
corsumm$tp <- ifelse(corsumm$p < 0.0001, "p < 0.0001", paste("p = ",corsumm$p, sep=""))

# setEPS()
# postscript(file = '../figures/trait_correlations.eps', family = "Times", width=16.9/2.56, height = 16/2.56)
# pdf(file = 'figures/03_genetic_correlations.pdf', width=16.9/2.56, height = 16/2.56)
par(mfrow=c(3,4), mar=c(4,3,1,0)+0.1, oma=c(0,1,1,1))

# fecundity vs survival
plot(ril_tofu$it2010, ril_surv$it2010, xlim=c(0,1600), xlab="", ylab="", main="Italy 2010")
text(1550, 0.25, bquote(atop('r'[P] ==  .(corsumm$rho[5]),  .(corsumm$tp[5]))), c(1,0))

title(ylab="Survival to reproduction", line=2)
plot(ril_tofu$it2011, ril_surv$it2011, xlim=c(0,1000),  xlab="", ylab="", main="Italy 2011")
text(1000, 0.45, bquote(atop('r'[P] ==  .(corsumm$rho[6]),  .(corsumm$tp[6]))), c(1,0))

plot(ril_tofu$sw2010, ril_surv$sw2010,  xlim=c(0,5500), ylim=c(0, 1), xlab="", ylab="", main="Sweden 2010")
text(5500, 0, bquote(atop('r'[P] ==  .(corsumm$rho[7]),  .(corsumm$tp[7]))), c(1,0))

plot(ril_tofu$sw2011, ril_surv$sw2011,  xlim=c(0,4000), ylim=c(0,1), xlab="", ylab="", main="Sweden 2011")
text(4000, 0, bquote(atop('r'[P] ==  .(corsumm$rho[8]),  .(corsumm$tp[8]))), c(1,0))
title(xlab="Number of seeds per reproductive plant", outer=T, line=-32.7)


# Frut vs seed number
plot(ril_frut$it2010, ril_numb$it2010, xlim=c(0,40), ylim=c(10,45), xlab="", ylab="", pch=1)
text(40, 10, bquote(atop('r'[P] ==  .(corsumm$rho[1]),  .(corsumm$tp[1]))), c(1,0))
title(ylab="Number of seeds per fruit", line=2)

plot(ril_frut$it2011, ril_numb$it2011, xlim=c(0,30), ylim=c(10,45), xlab="", ylab="", pch=1)
text(30, 10, bquote(atop('r'[P] ==  .(corsumm$rho[2]),  .(corsumm$tp[2]))), c(1,0))

plot(ril_frut$sw2010, ril_numb$sw2010, xlim=c(10,100), ylim=c(10,50), xlab="", ylab="", pch=1)
text(100, 10, bquote(atop('r'[P] ==  .(corsumm$rho[3]),  .(corsumm$tp[3]))), c(1,0))

plot(ril_frut$sw2011, ril_numb$sw2011, xlim=c(0,100), ylim=c(10,50), xlab="", ylab="", pch=1)
text(100, 10, bquote(atop('r'[P] ==  .(corsumm$rho[4]),  .(corsumm$tp[4]))), c(1,0))
title(xlab="Number of fruits per reproductive plant", line=-17, outer=T)

# fecundity vs seed mass
plot(ril_tofu$it2010, ril_mass$it2010, xlim=c(0,1600), ylim=c(0,45), xlab="", ylab="")
text(1550, 0, bquote(atop('r'[P] ==  .(corsumm$rho[9]),  .(corsumm$tp[9]))), c(1,0))
title(ylab="Mean seed mass (\U00B5g)", line=2)
title(xlab="Number of seeds per reproductive plant", ylab="", outer=T, line=-1.5)

plot(ril_tofu$it2011, ril_mass$it2011, xlim=c(0,1000), ylim=c(0,40), xlab="", ylab="")
text(1000, 0, bquote(atop('r'[P] ==  .(corsumm$rho[10]),  .(corsumm$tp[10]))), c(1,0))

plot(ril_tofu$sw2010, ril_mass$sw2010, xlim=c(0,6000), ylim=c(0,45), xlab="", ylab="")
text(6000, 0, bquote(atop('r'[P] ==  .(format(round(corsumm$rho[11], 2), nsmall = 2)), .(corsumm$tp[11]))), c(1,0))

plot(ril_tofu$sw2011, ril_mass$sw2011, xlim=c(0,3500), ylim=c(0,50), xlab="", ylab="")
text(3500, 0, bquote(atop('r'[P] ==  .(corsumm$rho[12]),  .(corsumm$tp[12]))), c(1,0))
# dev.off()
```

\newpage

```{r fig: epistatic-seed, fig.width=16.9/2.54, fig.height=10/2.54, cache=T, cache.lazy=T, fig.cap="Interaction plots for epistatic interactions detected for number of seeds per fruit, showing mean and standard errors for each genotype-by-genotype combination.", fig.scap = "Epistatic interactions for number of seeds per fruit", fig.align='center'}
# number of seeds per fruit
par(mfrow = c(1, 2))
effectplot(
  cross$seed,
  pheno.col = "it2011",
  mname1 = "1@5.3",
  mname2 = "5@15.0",
  add.legend = F,
  geno2 = c("It. allele", "Sw. allele"),
  main = "Italy 2011",
  xlab = "QTL 5@15.0",
  ylab = "Seeds per fruit"
)
legend(
  'topright',
  c("QTL 1@5.3", "It. allele", "Sw. allele"),
  col = c(0, 2, 4),
  pch = 1,
  bty = "n",
  cex = 0.8
)

effectplot(
  cross$seed,
  pheno.col = "sw2011",
  mname1 = "1@61.1",
  mname2 = "3@21.0",
  add.legend = F,
  geno2 = c("It. allele", "Sw. allele"),
  main = "Sweden 2011",
  xlab = "QTL 3@22.0",
  ylab = "Seeds per fruit"
)
legend(
  'topright',
  c("QTL 1@61.1", "It. allele", "Sw. allele"),
  col = c(0, 2, 4),
  pch = 1,
  bty = "n",
  cex = 0.8
)
```

```{r fig:epistatic-tofu, eval = T, fig.width = 9 / 2.54, fig.height = 10 /2.54, cache = T, cache.lazy = T, fig.cap = "Interaction plots for epistatic interactions detected for number of seeds per reproductive plant, showing mean and standard errors for each genotype-by-genotype combination.", fig.scap = "Epistatic interactions for number of seeds per reproductive plant", fig.align='center'}

# number of seeds per plant
par(mfrow = c(1, 1))
effectplot(
  cross$tofu,
  pheno.col = "sw2011",
  mname1 = "1@61.1",
  mname2 = "3@24.4",
  add.legend = F,
  ylim = c(500, 1100),
  geno2 = c("It. allele", "Sw. allele"),
  main = "Sweden 2011",
  xlab = "QTL 3@24.4",
  ylab = "Seeds per reproductive plant"
)
legend(
  'bottomleft',
  c("QTL 1@61.1", "It. allele", "Sw. allele"),
  col = c(0, 2, 4),
  pch = 1,
  bty = "n",
  cex=0.8
)


```

```{r fig: epistatic-tfit, fig.width=16.9/2.54, fig.height=10/2.54, cache=T, cache.lazy=T, fig.cap="Interaction plots for epistatic interactions detected for number of seeds per seedling planted, showing mean and standard errors for each genotype-by-genotype combination.", fig.scap = "Epistatic interactions for number of seeds per seedling planted", fig.align='center'}
# number of seeds per plant
par(mfrow = c(1, 2))
effectplot(
  cross$tfit,
  pheno.col = "it2010",
  mname1 = "3@18.0",
  mname2 = "5@12.0",
  add.legend = F,
  #ylim = c(500, 1100),
  geno2 = c("It. allele", "Sw. allele"),
  main = "Sweden 2011",
  xlab = "QTL 5@12.0",
  ylab = "Seeds per seedling planted"
)
legend('bottomleft', c("QTL 3@18.0", "It. allele", "Sw. allele"), col = c(0,2,4), pch=1, bty="n", cex=0.8)

effectplot(
  cross$tfit,
  pheno.col = "sw2011",
  mname1 = "1@61.1",
  mname2 = "3@18.0",
  add.legend = F,
  #ylim = c(500, 1100),
  geno2 = c("It. allele", "Sw. allele"),
  main = "Sweden 2011",
  xlab = "QTL 3@18:0",
  ylab = "Seeds per seedling planted"
)
legend('bottomleft', c("QTL 1@61.1", "It. allele", "Sw. allele"), col = c(0,2,4), pch=1, bty="n", cex=0.8)

```

\newpage

```{r heritabilities, fig.cap="Broad-sense heritability estimates for survival to reproduction, number of fruits per reproductive plant (Fruits/RP), number of seeds per fruit (Seeds/fr), number of fruits per seedling planted (Fruits/sdl), and seed mass. Closed and open symbols show values in Italy and Sweden respectively. Error bars show 95% parametric bootstrap confidence intervals. Numbers indicate the number of individuals each estimate is based on."}

# pdf("figures/heritabilities.pdf", width=16.9/2.54, height = 12/2.54)
par(mfrow=c(1,2))

os <- 0.1
plot(
  c(1, 6),
  c(0, 0.6),
  type = "n",
  axes = F,
  xlim = c(0.2, 5.5),
  xlab = "",
  ylab = "Broad-sense heritability",
  main = "2010"
)
axis(1, 1:5, las=2,
     labels = c("Survival", "Fruits/RP", "Seeds/fr", "Fruits/sdl", "Seed mass"))
axis(2)
box()
# Confidence intervals
segments((1:5) - os, H2$lower$`Italy 2010`,
         (1:5) - os, H2$upper$`Italy 2010`)
segments((1:5) + os, H2$lower$`Sweden 2010`,
         (1:5) + os, H2$upper$`Sweden 2010`)
# Overplot observed values
points((1:5) - os, H2$obs$`Italy 2010`,   pch=16)
points((1:5) + os, H2$obs$`Sweden 2010`, pch=21, bg="white")

# Add sample sizes
text((1:5) - 1.5*os, 0.6,
     labels = H2$n$`Italy 2010`,
     adj = 1,
     srt=90,
     cex=0.7)
text((1:5) + 1.5*os, 0.6,
     labels = H2$n$`Sweden 2010`,
     srt=90,
     adj=1,
     cex=0.7)

# 2011
plot(c(1, 5), c(0,0.6), type="n", axes = F, xlim= c(0.5, 5.5),
     xlab="", ylab="Broad-sense heritability", main="2011")
axis(1, 1:5, las=2,
     labels = c("Survival", "Fruits/RP", "Seeds/fr", "Fruits/sdl", "Seed mass"))
axis(2)
box()
# Confidence intervals
segments((1:5) - os, H2$lower$`Italy 2011`,
         (1:5) - os, H2$upper$`Italy 2011`)
segments((1:5) + os, H2$lower$`Sweden 2011`,
         (1:5) + os, H2$upper$`Sweden 2011`)
# Overplot observed values
points((1:5) - os, H2$obs$`Italy 2011`,   pch=16)
points((1:5) + os, H2$obs$`Sweden 2011`, pch=21, bg="white")

# Add sample sizes
text((1:5) - 1.5*os, 0.6,
     labels = H2$n$`Italy 2011`,
     adj = 1,
     srt=90,
     cex=0.7)
text((1:5) + 1.5*os, 0.6,
     labels = H2$n$`Sweden 2011`,
     srt=90,
     adj=1,
     cex=0.7)

# dev.off()
```
